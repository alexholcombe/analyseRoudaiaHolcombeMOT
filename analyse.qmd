---
title: "Psychophysical model recovery using Bayesian brms"
format: html
---

```{r}
#| warning: true 
#| output: false

rm(list = ls()) #Clear workspace
library(here) #To find path of home directory of repo
library(tidyverse)
library(brms)

#Define function for when need to catch warnings and errors, https://stackoverflow.com/questions/4948361/how-do-i-save-warnings-and-errors-as-output-from-a-function
myTryCatch <- function(expr) { 
  warn <- err <- NULL
  value <- withCallingHandlers(
    tryCatch(expr, error=function(e) {
      err <<- e
      NULL
    }), warning=function(w) {
      warn <<- w
      invokeRestart("muffleWarning")
    })
  list(value=value, warning=warn, error=err)
}
```


```{r}
#| echo: false
#| warning: true 
#| output: false

Roudaia_data_dir<- here("dataDeidentified")
if (!dir.exists(Roudaia_data_dir)) {
  stop("Was looking for this directory but doesn't exist:",Roudaia_data_dir)
}
Roudaia_data_deidentified_file<- file.path( Roudaia_data_dir,"Roudaia_preprocessed.tsv" )
if (!file.exists(Roudaia_data_deidentified_file)) {
  stop("Was looking for this directory but doesn't exist:",Roudaia_data_deidentified_file)
}

Roudaia_data <- readr::read_tsv(Roudaia_data_deidentified_file) #skip incorrect header
#Code gender in same way as Holcombe, with male and female
Roudaia_data<- Roudaia_data |> mutate(gender = case_when(
    gender == "M" ~ "male",
    gender == "F" ~ "female",
    TRUE ~ gender))
#Code ageGroup in same way as Holcombe
Roudaia_data <- Roudaia_data %>%
  mutate(ageGroup = case_when(
    ageGroup == "Old" ~ "older",
    ageGroup == "Young" ~ "younger",
    TRUE ~ ageGroup
  ))
```

Read Holcombe data from github

```{r}
#| echo: false

#This reads anonymized data provided by "loadAnonymiseSaveData.R" in exp-specific directory of my MOTcircularClean repo

#https://raw.githubusercontent.com/alexholcombe/MOTcircularClean/refs/heads/main/dataAnonymized/youngOld/youngOld_psychopy_data.tsv
#https://github.com/alexholcombe/MOTcircularClean/tree/main/dataAnonymized/youngOld
HolcombeExpName<- "youngOld"
HolcombeDataDir<- paste0("dataAnonymized","/",HolcombeExpName)
HolcombeRepoRaw<- "https://raw.githubusercontent.com/alexholcombe/MOTcircularClean/refs/heads/main/"
HolcombeDataFile<- "youngOld_psychopy_data.tsv"
HolcombeDataURL<- paste0(HolcombeRepoRaw,HolcombeDataDir,"/",HolcombeDataFile)

dfWithWarnings<- myTryCatch( 
      readr::read_tsv(HolcombeDataURL) 
    )

if (!is.null(dfWithWarnings$warning)) {
  print("Warnings reading Holcombe data:")
  print(dfWithWarnings$warning)
}
if (!is.null(dfWithWarnings$error)) {
  print("Error reading Holcombe data:")
  print(dfWithWarnings$error)
}
Holcombe_data<- dfWithWarnings$value
numSsHolcombe<- length(table(Holcombe_data$IDnum)) #58
message("Have read in the Holcombe data for ",numSsHolcombe," deidentified participants.")

```

Read the files info guide that provides mapping to EDF files, from the .tsv file generated by loadAnonymiseSaveData.R in dataPreprocess directory of the repo.
```{r}
#| echo: false

HolcombeRepoRaw<- "https://raw.githubusercontent.com/alexholcombe/MOTcircularClean/refs/heads/main/"
HolcombeFilesGuide<- "youngOld_files_guide.tsv"
HolcombeFilesGuideURL<- paste0(HolcombeRepoRaw,HolcombeDataDir,"/",HolcombeDataFile)

HolcombeFilesGuide<- myTryCatch( 
      readr::read_tsv(HolcombeFilesGuideURL) 
    )
```

```{r}
#| echo: false
####################
#Get age and sex info - an anonymised copy of the Sharepoint participant sheet with many columns 
#  redacted that was created by loadAnonymiseSaveData.R
HolcombeAgeGenderFile<- "participantInfo_reducedForPrivacy.tsv"
HolcombeAgeGenderURL<- paste0(HolcombeRepoRaw,HolcombeDataDir,"/",HolcombeAgeGenderFile)
HolcombeAgeGender<- myTryCatch( 
      readr::read_tsv(HolcombeAgeGenderURL) 
    )
if (!is.null(HolcombeAgeGender$warning)) {
  print("Warnings reading HolcombeAgeGender data:")
  print(HolcombeAgeGender$warning)
}
if (!is.null(HolcombeAgeGender$error)) {
  print("Error reading HolcombeAgeGender data:")
  print(HolcombeAgeGender$error)
}
HolcombeAgeGender<- HolcombeAgeGender$value

#Classify age
HolcombeAgeGender<- HolcombeAgeGender |> 
            mutate(ageGroup = if_else(agePerturbed>60, "older", "younger"))

```

Plot age distros of Roudaia and Holcombe on same plot.
They look similar except Holcombe has a lot more young participants, in particular young females.

```{r}
#| echo: false
#Extract Roudaia age and gender by taking the first trial of each participant
RoudaiaAgeGender<- Roudaia_data |> group_by(subj, gender) |> slice(1) |>
              select(subj,age,gender,ageGroup) |> mutate(lab="Roudaia")

ageGenderBothLabs<- rbind( RoudaiaAgeGender, 
              HolcombeAgeGender |> select(agePerturbed,gender,ageGroup) |> 
                                    rename(age = agePerturbed) |>
                                    mutate(lab="Holcombe")
  )

ggplot(ageGenderBothLabs, aes(x = age, fill = gender)) +
  geom_histogram(position = "stack", bins = 30) +
  facet_grid(lab ~ ageGroup, scales = "free_x") +
  scale_fill_manual( values = c("female" = "#C71585", "male" = "blue") ) +
  labs(
    x = "Age",
    y = "Count",
    fill = "Gender",
    title = "Stacked Histogram of Age by Gender, Lab"
  ) +
  theme_bw()
```


###Join age and sex to behavioural data
ageGender<- pInfoReducedForPrivacy |> select(IDnum,gender,age,agePerturbed)
#ALSO ADD ACUITY AND CROWDING for exploratory analyses
rawData<- rawData |> left_join(ageGender, by = join_by(IDnum))

```


###################################################
############Exclusion criteria########################
#################################################
excludeDidntReach75pct = TRUE




#Define function for when need to catch warnings and errors, https://stackoverflow.com/questions/4948361/how-do-i-save-warnings-and-errors-as-output-from-a-function
myTryCatch <- function(expr) { 
  warn <- err <- NULL
  value <- withCallingHandlers(
    tryCatch(expr, error=function(e) {
      err <<- e
      NULL
    }), warning=function(w) {
      warn <<- w
      invokeRestart("muffleWarning")
    })
  list(value=value, warning=warn, error=err)
}



dfWithWarnings<- myTryCatch( 
    readr::read_csv(Roudaia_data_file_with_path, show_col_types=TRUE) 
  )
if (!is.null(dfWithWarnings$warning)) {
  print("Warnings reading Roudaia data:")
  print(dfWithWarnings$warning)
}
if (!is.null(dfWithWarnings$error)) {
  print("Error reading Roudaia data:")
  print(dfWithWarnings$error)
}
Roudaia_data<- dfWithWarnings$value
numSs<- length(table(Roudaia_data$subj)) #36

#"cond has pretty self explanatory condition names:
#  t1.d05 == 1 targe`t, 5 objects per ring. t2.d10: 2 targets, 10 objects per ring."

Roudaia_data <- Roudaia_data %>%
  separate(cond, into = c("targetsString", "objsString"), sep = "\\.", remove = FALSE) %>%
  mutate(
    numTargets = as.integer(sub("^0*", "", sub(".*t(\\d+).*", "\\1", targetsString))),
    objPerRing = as.integer(sub("^0*", "", sub(".*d(\\d+).*", "\\1", objsString)))
  )
Roudaia_data$cond<- NULL
Roudaia_data$targetsString<- NULL
Roudaia_data$objsString<- NULL

#Validate the ChatGPT data
#table(Roudaia_data$cond,Roudaia_data$numTargets)
#table(Roudaia_data$cond,Roudaia_data$objPerRing)

# responseRing is the ring that was probed for the response. 1 = inner, 2 = middle 3 = outer,
# Response ring strangely has many more outer, then inner, then middle
tab <- table(Roudaia_data$subj, Roudaia_data$responseRing)
# Convert counts to row-wise percentages, for each subject
#tab_pct <- prop.table(tab, margin = 1) * 100
#print( round(tab_pct,0) )
ring_response_percent <- Roudaia_data %>%
  count(responseRing) %>%
  mutate(percent = 100 * n / sum(n))
print(ring_response_percent) #28%, 11%, 61%

Roudaia_data <- Roudaia_data %>%
  mutate(ageGroup = if_else(group == 1, "younger", "older"))
Roudaia_data$group<-NULL

#Plot data for each participant
gg<- ggplot(Roudaia_data, #data_one_condition, 
            aes(x=speed,y=correct,linetype=factor(objPerRing),
                color=factor(numTargets))) +
  stat_summary(fun=mean,geom="point") +
  stat_summary(fun=mean,geom="smooth")  +
  facet_wrap(subj~.) +
  labs(x = "Speed (revolutions per second)",
       y = "Correct",
       title = "Roudaia raw data") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()) #remove gridlines

#Show floor with lines
gg<- gg + geom_hline( aes(yintercept = 1/objPerRing),
                      colour = "purple", alpha=0.2 )
show(gg)

destination_fname<- "Roudaia_preprocessed.tsv"
destination<- here("dataPreprocess",destination_fname)
readr::write_tsv(Roudaia_data, file = destination)