---
title: "Psychophysical model recovery using Bayesian brms"
format: html
---

```{r}
#| warning: true 
#| output: false

rm(list = ls()) #Clear workspace
library(here) #To find path of home directory of repo
library(tidyverse)
library(brms)

#Define function for when need to catch warnings and errors, https://stackoverflow.com/questions/4948361/how-do-i-save-warnings-and-errors-as-output-from-a-function
myTryCatch <- function(expr) { 
  warn <- err <- NULL
  value <- withCallingHandlers(
    tryCatch(expr, error=function(e) {
      err <<- e
      NULL
    }), warning=function(w) {
      warn <<- w
      invokeRestart("muffleWarning")
    })
  list(value=value, warning=warn, error=err)
}
```


```{r}
#| echo: false
#| warning: true 
#| output: false

Roudaia_data_dir<- here("dataDeidentified")
if (!dir.exists(Roudaia_data_dir)) {
  stop("Was looking for this directory but doesn't exist:",Roudaia_data_dir)
}
Roudaia_data_deidentified_file<- file.path( Roudaia_data_dir,"Roudaia_preprocessed.tsv" )
if (!file.exists(Roudaia_data_deidentified_file)) {
  stop("Was looking for this directory but doesn't exist:",Roudaia_data_deidentified_file)
}

Roudaia_data <- readr::read_tsv(Roudaia_data_deidentified_file) 

numSs<- length(table(Roudaia_data$subj)) #36


```

Read Holcombe data from github.

```{r}
#| echo: false

#This reads anonymized data provided by "loadAnonymiseSaveData.R" in exp-specific directory of my MOTcircularClean repo

#https://raw.githubusercontent.com/alexholcombe/MOTcircularClean/refs/heads/main/dataAnonymized/youngOld/youngOld_psychopy_data.tsv
#https://github.com/alexholcombe/MOTcircularClean/tree/main/dataAnonymized/youngOld
HolcombeExpName<- "youngOld"
HolcombeDataDir<- paste0("dataAnonymized","/",HolcombeExpName)
HolcombeRepoRaw<- "https://raw.githubusercontent.com/alexholcombe/MOTcircularClean/refs/heads/main/"
HolcombeDataFile<- "youngOld_psychopy_data.tsv"
HolcombeDataURL<- paste0(HolcombeRepoRaw,HolcombeDataDir,"/",HolcombeDataFile)

dfWithWarnings<- myTryCatch( 
      readr::read_tsv(HolcombeDataURL) 
    )

if (!is.null(dfWithWarnings$warning)) {
  print("Warnings reading Holcombe data:")
  print(dfWithWarnings$warning)
}
if (!is.null(dfWithWarnings$error)) {
  print("Error reading Holcombe data:")
  print(dfWithWarnings$error)
}
Holcombe_data<- dfWithWarnings$value
numSsHolcombe<- length(table(Holcombe_data$IDnum)) #58
message("Have read in the Holcombe data for ",numSsHolcombe," deidentified participants.")

```

Read the files info guide that provides mapping to EDF files, from the .tsv file generated by loadAnonymiseSaveData.R in dataPreprocess directory of the repo.
```{r}
#| echo: false

HolcombeRepoRaw<- "https://raw.githubusercontent.com/alexholcombe/MOTcircularClean/refs/heads/main/"
HolcombeFilesGuide<- "youngOld_files_guide.tsv"
HolcombeFilesGuideURL<- paste0(HolcombeRepoRaw,HolcombeDataDir,"/",HolcombeDataFile)

HolcombeFilesGuide<- myTryCatch( 
      readr::read_tsv(HolcombeFilesGuideURL) 
    )
```

```{r}
#| echo: false
####################
#Get age and sex info - an anonymised copy of the Sharepoint participant sheet with many columns 
#  redacted that was created by loadAnonymiseSaveData.R
HolcAgeGenderAcuityCrowdingFile<- "participantInfo_reducedForPrivacy.tsv"
HolcAgeGenderAcuityCrowdingURL<- paste0(HolcombeRepoRaw,HolcombeDataDir,"/",HolcAgeGenderAcuityCrowdingFile)
HolcAgeGenderAcuityCrowding<- myTryCatch( 
      readr::read_tsv(HolcAgeGenderAcuityCrowdingURL) 
    )
if (!is.null(HolcAgeGenderAcuityCrowding$warning)) {
  print("Warnings reading HolcAgeGenderAcuityCrowding data:")
  print(HolcAgeGenderAcuityCrowding$warning)
}
if (!is.null(HolcAgeGenderAcuityCrowding$error)) {
  print("Error reading HolcAgeGenderAcuityCrowding data:")
  print(HolcAgeGenderAcuityCrowding$error)
}
HolcAgeGenderAcuityCrowding<- HolcAgeGenderAcuityCrowding$value

#Classify age
HolcAgeGenderAcuityCrowding<- HolcAgeGenderAcuityCrowding |> 
            mutate(ageGroup = if_else(agePerturbed>60, "older", "younger"))

```

Plot age distros of Roudaia and Holcombe on same plot.
They look similar except Holcombe has a lot more young participants, in particular especially-young females.

```{r}
#| echo: false
#Extract Roudaia age and gender by taking the first trial of each participant
RoudaiaAgeGender<- Roudaia_data |> group_by(subj, gender) |> slice(1) |>
              select(subj,age,gender,ageGroup) |> mutate(lab="Roudaia")

ageGenderBothLabs<- rbind( RoudaiaAgeGender, 
              HolcAgeGenderAcuityCrowding |> select(agePerturbed,gender,ageGroup) |> 
                                    rename(age = agePerturbed) |>
                                    mutate(lab="Holcombe")
  )

ggplot(ageGenderBothLabs, aes(x = age, fill = gender)) +
  geom_histogram(position = "stack", bins = 30) +
  facet_grid(lab ~ ageGroup, scales = "free_x") +
  scale_fill_manual( values = c("female" = "#C71585", "male" = "blue") ) +
  labs(
    x = "Age",
    y = "Count",
    fill = "Gender",
    title = "Stacked Histogram of Age by Gender, Lab"
  ) +
  theme_bw()
```

Join age and sex to behavioural data, as well as acuity and crowding measures

```{r}
#| echo: false
#| 
Holcombe_data<- Holcombe_data |> left_join(HolcAgeGenderAcuityCrowding, by = join_by(IDnum))

#For readability, move some columns to before all the acuity and crowding stuff
Holcombe_data <- Holcombe_data %>%
  relocate(agePerturbed, ageGroup, orderCorrect, .after = IDnum)

Holcombe_data$basicShape<- NULL

#To be same as Roudaia, rename IDnum subj and orderCorrect
Holcombe_data<- Holcombe_data |> rename(subj = IDnum)
Holcombe_data<- Holcombe_data |> mutate(correct = (orderCorrect==3))
Holcombe_data$correct<- as.numeric(Holcombe_data$correct)

#Add a genderSymbol useful for plotting annotation
Roudaia_data <- Roudaia_data %>%
  mutate(genderSymbol = if_else(gender == "M", "\u2642", "\u2640"))
Holcombe_data <- Holcombe_data %>%
  mutate(genderSymbol = if_else(gender == "M", "\u2642", "\u2640"))

```

## Exclusions for not reaching decent performance


Roudaia: "The zip contains all 36 subjects included in the paper." So this seems to mean that it includes the excluded participants mentioned next

Roudaia: "In nine cases, two older male participants and five older female participants showed poor performance at the slowest speeds and the fit of the logistic curve was inadequate, with the threshold estimated to be below zero. This occurred for two thresholds in the three targets and five dots/ring condition, one threshold from the two targets and 10 dots/ring condition, and six thresholds on the three targets and 10 dots/ring condition. These nine thresholds were coded as missing data in the linear mixed-effects model analyses and were not included in the summary statistics shown in the figures."
But I can see from inspecting her plots that at least in the 3 targets condition, at least four participants didn't exceed 50%. But Roudaia didn't say whether those participants were thrown out for creation of the data she sent me.

Plot Holcombe data, looking for participants who didn't reach 75% at slow speeds.
excludeDidntReach75pct = TRUE

Plot young participants
```{r}
#| echo: false

#Plot young participants
gg<- ggplot(Holcombe_data |> filter(ageGroup=="younger"),
            aes(x=speed,y=correct,linetype=factor(numObjects),
                color=factor(numTargets) )) +
  stat_summary(fun=mean,geom="point") +
  stat_summary(fun=mean,geom="smooth")  +
  facet_wrap(subj~.) +
  labs(x = "Speed (revolutions per second)",
       y = "Correct",
       title = "Holcombe younger") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()) #remove gridlines

#Show floor with lines
gg<- gg + geom_hline( aes(yintercept = 1/numObjects),
                      colour = "purple", alpha=0.2 )
show(gg)
```
Plot old participants
```{r}
#| echo: false

#Plot young participants
gg<- ggplot(Holcombe_data |> filter(ageGroup=="older"),
            aes(x=speed,y=correct,linetype=factor(numObjects),
                color=factor(numTargets) )) +
  stat_summary(fun=mean,geom="point") +
  stat_summary(fun=mean,geom="smooth")  +
  facet_wrap(subj~.) +
  labs(x = "Speed (revolutions per second)",
       y = "Correct",
       title = "Holcombe older") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()) #remove gridlines

#Show floor with lines
gg<- gg + geom_hline( aes(yintercept = 1/numObjects),
                      colour = "purple", alpha=0.2 )
show(gg)
```

Zoom in on slow speeds so can see better how many should be excluded.
In addition to the staircase, the Holcombe program periodically threw in a slow speed (.02 rps).
How low did Roudaia speeds go?

Looking at speeds tested by Roudaia, 

```{r}
#| echo: false

head(table( round(Roudaia_data$speed,4) ), 25)
```
you can see that 0.05rps was tested a lot, other than that the only lower ones were 0.02 and 0.03, which were tested only 3 times! Why would that be?

All the Holcombe young participants did great at the slowest speed!

```{r}
#| echo: false

#Plot young participants
gg<- ggplot(Holcombe_data |> filter(ageGroup=="younger", speed < 0.3) ,
            aes(x=speed,y=correct,linetype=factor(numObjects),
                color=factor(numTargets) )) +
  stat_summary(fun=mean,geom="point") +
  stat_summary(fun=mean,geom="smooth")  +
  facet_wrap(subj~.) +
  labs(x = "Speed (revolutions per second)",
       y = "Correct",
       title = "Holcombe younger") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()) #remove gridlines

#Show floor with lines
gg<- gg + geom_hline( aes(yintercept = 1/numObjects),
                      colour = "purple", alpha=0.2 )
show(gg)
```
Zoom in on slow speeds so can see better how many should be excluded.
In addition to the staircase, the Holcombe program periodically threw in a slow speed (.02 rps)

All the Roudaia young participants did ok at the slowest speed. Some were barely at 75% but hard to tell because staircase didn't give consistent speeds, estimation is better.

```{r}
#| echo: false

#Plot young participants
gg<- ggplot(Roudaia_data |> filter(ageGroup=="younger", speed < 1.4) ,
            aes(x=speed,y=correct,linetype=factor(numObjects),
                color=factor(numTargets) )) +
  stat_summary(fun = mean, geom = "point", position = position_jitter(width = 0.02)) +
  #stat_summary(fun=mean,geom="smooth")  +
  facet_wrap(subj~.) +
  labs(x = "Speed (revolutions per second)",
       y = "Correct",
       title = "Roudaia younger") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()) #remove gridlines

#Show floor with lines
gg<- gg + geom_hline( aes(yintercept = 1/numObjects),
                      colour = "purple", alpha=0.2 )
show(gg)
```

Check older participants slowest speeds.
All Holcombe older participants did well at slowest speed! Although some did so badly at slightly-faster speeds that I have to think they can't track, only remember a few locations.
```{r}
#| echo: false

gg<- ggplot(Holcombe_data |> filter(ageGroup=="older", speed < 0.3) ,
            aes(x=speed,y=correct,linetype=factor(numObjects),
                color=factor(numTargets) )) +
  stat_summary(fun=mean,geom="point") +
  stat_summary(fun=mean,geom="smooth")  +
  facet_wrap(subj~.) +
  labs(x = "Speed (revolutions per second)",
       y = "Correct",
       title = "Holcombe older") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()) #remove gridlines

#Show floor with lines
gg<- gg + geom_hline( aes(yintercept = 1/numObjects),
                      colour = "purple", alpha=0.2 )
show(gg)
```

For Roudaia older, see below, these participants don't get to 75% in 3 targets:
203 F?, 209 F, 211 F, 212 F, 215 F, 221 M, 225 F, 226 F, 227 F
But without knowing the number of trials per datapoint, this is highly questionable!!

```{r}
#| echo: false

# Prepare gender annotation data: one row per subject with gender symbol and upper-right coordinates
gender_annotatn <- Roudaia_data |> filter(ageGroup == "older", speed < 0.8) |>
  group_by(subj) %>%
  summarise(
    genderSymbol = first(genderSymbol),
    x = max(speed, na.rm = TRUE),
    y = max(correct, na.rm = TRUE),
    .groups = "drop"
  )

gg <- ggplot(Roudaia_data |> filter(ageGroup == "older", speed < 0.8),
             aes(x = speed, y = correct, linetype = factor(numObjects),
                 color = factor(numTargets))) +
  stat_summary(fun = mean, geom = "point", position = position_jitter(width = 0.02)) +
  facet_wrap(subj ~ .) +
 geom_text(
    data = gender_annotatn,
    aes(x = x, y = y, label = genderSymbol),
    inherit.aes = FALSE,
    hjust = 1, vjust = 1, size = 6
  ) +
  labs(x = "Speed (revolutions per second)",
       y = "Correct",
       title = "Roudaia older") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

#Show floor with lines
gg<- gg + geom_hline( aes(yintercept = 1/numObjects),
                      colour = "purple", alpha=0.2 ) +
    geom_hline(yintercept=0.75, alpha=0.2)

show(gg)
```